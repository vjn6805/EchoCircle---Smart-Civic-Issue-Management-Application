<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard | EchoCircle</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { 
      height: 100%; 
      width: 100%;
      border-radius: 1rem;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .issue-card {
      animation: slideIn 0.3s ease-out forwards;
    }
    
    .issue-card:hover {
      transform: translateY(-2px);
      transition: all 0.3s ease;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-gray-50 to-blue-50">
  <!-- Navbar -->
  <nav class="flex justify-between items-center px-6 md:px-8 py-4 bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
    <h1 class="text-2xl md:text-3xl font-bold gradient-text">EchoCircle</h1>
    <div class="flex items-center gap-3 md:gap-6">
      <div class="hidden md:flex items-center gap-2 bg-blue-50 px-4 py-2 rounded-lg">
        <a href="/user/my_issues" class="text-blue-600 hover:text-blue-800 font-semibold">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <span class="text-gray-700 font-semibold">{{ name }}</span></a>
      </div>
      <div>
        <a href="/user/feed" class="text-gray-600 hover:text-blue-600 font-medium transition flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
          </svg>
          <span class="hidden md:inline">Feed</span>
        </a>
      </div>
      <a href="/user/report" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 md:px-6 py-2.5 rounded-lg hover:from-blue-700 hover:to-blue-800 transition shadow-lg hover:shadow-xl font-semibold flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span class="hidden md:inline">Report Issue</span>
      </a>
      <a href="/logout" class="text-gray-600 hover:text-blue-600 font-medium transition flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        <span class="hidden md:inline">Logout</span>
      </a>
    </div>
  </nav>

  <!-- Dashboard Container -->
  <div class="p-4 md:p-6 h-[calc(100vh-80px)]">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 h-full">
      
      <!-- Left Panel: Interactive Map -->
      <div class="md:col-span-2 bg-white rounded-2xl shadow-xl overflow-hidden p-4 relative">
        <div class="absolute top-6 left-6 z-10 bg-white/95 backdrop-blur-sm px-4 py-2 rounded-lg shadow-lg">
          <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
            Community Issue Map
          </h2>
        </div>
        <div id="map"></div>
      </div>

      <!-- Right Panel: Issue List -->
      <div class="md:col-span-1 bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-6 border-b border-gray-200">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Recent Issues
          </h2>
          <p class="text-gray-600 text-sm mt-1">{{ issues|length }} active reports</p>
        </div>

        <!-- Issue Cards Container -->
        <div class="overflow-y-auto flex-1 p-4 space-y-3 scrollbar-thin">
          {% for issue in issues %}
          <div onclick="openIssueModal(this.dataset.issue)" 
     data-issue='{{ issue | tojson }}'
     class="issue-card bg-white p-5 rounded-xl shadow-md hover:shadow-lg border border-gray-200 cursor-pointer" 
     style="animation-delay: {{ loop.index0 * 0.1 }}s;">

            <!-- Issue Header -->
            <div class="flex items-start justify-between mb-3">
              <h3 class="font-bold text-gray-800 text-base flex-1 pr-2">{{ issue.title }}</h3>
              <div class="flex-shrink-0">
                {% if issue.status == 'Resolved' %}
                <span class="status-badge bg-green-100 text-green-700">
                  ‚úì Resolved
                </span>
                {% elif issue.status == 'In Progress' %}
                <span class="status-badge bg-yellow-100 text-yellow-700">
                  ‚è≥ In Progress
                </span>
                {% else %}
                <span class="status-badge bg-red-100 text-red-700">
                  ‚ö† Pending
                </span>
                {% endif %}
              </div>
            </div>

            <!-- Category Badge -->
            <div class="flex items-center gap-2 mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
              <span class="text-sm text-gray-600 font-medium">{{ issue.category }}</span>
            </div>

            <!-- Upvote Section -->
            <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-200">
              <div class="flex items-center gap-2 text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                </svg>
                <span class="font-bold text-gray-800">{{ issue.upvotes }}</span>
                <span class="text-sm">upvotes</span>
              </div>
              {% if issue.user_voted %}
              <button disabled class="bg-gray-400 text-white px-4 py-1.5 rounded-lg flex items-center gap-1 text-sm font-semibold cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Voted
              </button>
              {% else %}
              <button onclick="event.stopPropagation(); upvoteIssue({{ issue.issue_id }}, this)" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg hover:bg-blue-700 transition shadow-sm hover:shadow-md flex items-center gap-1 text-sm font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>
                Upvote
              </button>
              {% endif %}
            </div>
          </div>
          {% endfor %}

          {% if not issues %}
          <div class="text-center py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
            <p class="text-gray-500 font-medium">No issues reported yet</p>
            <p class="text-gray-400 text-sm mt-1">Be the first to report an issue!</p>
          </div>
          {% endif %}
        </div>

        <!-- Footer Stats -->
        <div class="bg-gray-50 p-4 grid grid-cols-3 gap-2 border-t border-gray-200">
          <div class="text-center">
            <div class="text-2xl font-bold text-gray-800">{{ issues|length }}</div>
            <div class="text-xs text-gray-600">Total</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600">
              {{ total_resolved }}
            </div>
            <div class="text-xs text-gray-600">Resolved</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-yellow-600">
              {{ issues|rejectattr('status', 'equalto', 'Resolved')|list|length }}
            </div>
            <div class="text-xs text-gray-600">Pending</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Initialize map centered on Ahmedabad
    const map = L.map('map').setView([{{ lat }}, {{ lon }}], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Add markers from Flask data
    const issues = {{ issues | tojson }};
    issues.forEach(issue => {
      const marker = L.marker([issue.latitude, issue.longitude]).addTo(map);
      
      marker.bindPopup(`
        <div style="min-width: 200px;">
          <h3 style="font-weight: bold; color: #374151; margin-bottom: 8px;">${issue.title}</h3>
          <p style="margin: 4px 0;"><strong>Category:</strong> ${issue.category}</p>
          <p style="margin: 4px 0;"><strong>Status:</strong> <span style="color: ${issue.status === 'Resolved' ? '#22c55e' : issue.status === 'In Progress' ? '#eab308' : '#ef4444'};">${issue.status}</span></p>
          <p style="margin: 4px 0;"><strong>Upvotes:</strong> ${issue.upvotes}</p>
        </div>
      `);
    });

    // Fit map to show all markers if there are any
    if (issues.length > 0) {
      const bounds = L.latLngBounds(issues.map(i => [i.latitude, i.longitude]));
      map.fitBounds(bounds, { padding: [50, 50] });
    }

    // Upvote function
    function upvoteIssue(issueId, button) {
      button.disabled = true;
      button.innerHTML = '<svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Upvoting...';
      
      fetch(`/upvote/${issueId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update upvote count in UI
          const upvoteSpan = button.parentElement.querySelector('span:nth-child(2)');
          upvoteSpan.textContent = data.upvotes;
          
          // Change button to voted state
          button.disabled = true;
          button.className = 'bg-gray-400 text-white px-4 py-1.5 rounded-lg flex items-center gap-1 text-sm font-semibold cursor-not-allowed';
          button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Voted';
          
          // Re-sort issues by moving this card to correct position
          const issueCard = button.closest('.issue-card');
          const container = issueCard.parentElement;
          const allCards = Array.from(container.querySelectorAll('.issue-card'));
          
          // Remove current card temporarily
          issueCard.remove();
          
          // Find correct position for descending order
          let inserted = false;
          for (let card of allCards) {
            if (card === issueCard) continue;
            const cardUpvotes = parseInt(card.querySelector('span:nth-child(2)').textContent);
            if (data.upvotes > cardUpvotes) {
              container.insertBefore(issueCard, card);
              inserted = true;
              break;
            }
          }
          
          // If not inserted (highest votes), add to beginning
          if (!inserted) {
            container.insertBefore(issueCard, container.firstChild);
          }
          
          // Add highlight animation
          issueCard.style.backgroundColor = '#dbeafe';
          setTimeout(() => {
            issueCard.style.backgroundColor = '';
          }, 1000);
        } else {
          alert(data.message || 'Failed to upvote');
          button.disabled = false;
          button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg> Upvote';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
        button.disabled = false;
        button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg> Upvote';
      });
    }

    // ====================== Issue Details Modal ======================
function openIssueModal(issueData) {
  try {
    const issue = JSON.parse(issueData);
    console.log('Opening modal for issue:', issue);
    
    const modal = document.getElementById('issue-modal');
    
    // Fill modal data
    document.getElementById('modal-title').textContent = issue.title || 'No Title';
    document.getElementById('modal-category').textContent = (issue.category || 'Unknown') + ' ‚Ä¢ ' + (issue.severity || 'N/A');
    document.getElementById('modal-description').textContent = issue.description || 'No description provided.';
    document.getElementById('modal-upvotes').querySelector('span').textContent = (issue.upvotes || 0) + ' upvotes';
    document.getElementById('modal-location').textContent = 'üìç ' + (issue.city || 'Unknown City') + ' (' + parseFloat(issue.latitude).toFixed(4) + ', ' + parseFloat(issue.longitude).toFixed(4) + ')';

    // Status badge
    const statusEl = document.getElementById('modal-status');
    statusEl.textContent = issue.status || 'Unknown';
    statusEl.className = 'px-3 py-1 rounded-full text-sm font-semibold';
    if (issue.status === 'Resolved') statusEl.classList.add('bg-green-100', 'text-green-700');
    else if (issue.status === 'In Progress') statusEl.classList.add('bg-yellow-100', 'text-yellow-700');
    else statusEl.classList.add('bg-red-100', 'text-red-700');

    // Image (if exists)
    const imgDiv = document.getElementById('modal-image');
    if (issue.image_path) {
      imgDiv.querySelector('img').src = '/' + issue.image_path;
      imgDiv.classList.remove('hidden');
    } else {
      imgDiv.classList.add('hidden');
    }

    // Show modal
    modal.classList.remove('hidden');
  } catch (error) {
    console.error('Error opening modal:', error);
    alert('Error opening issue details');
  }
}

// Close modal
function closeModal() {
  document.getElementById('issue-modal').classList.add('hidden');
}

// Close modal on background click
window.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('issue-modal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target.id === 'issue-modal') closeModal();
    });
  }
});

  </script>

<!-- Issue Details Modal -->
<div id="issue-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] hidden">
  <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 overflow-hidden animate-fadeIn relative">
    <!-- Close button -->
    <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-500 hover:text-red-600">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Modal Content -->
    <div id="modal-content" class="p-6 md:p-8">
      <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-2"></h2>
      <p id="modal-category" class="text-sm font-medium text-blue-600 mb-4"></p>

      <div class="flex items-center justify-between mb-4">
        <span id="modal-status" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
        <span id="modal-upvotes" class="text-sm text-gray-700 flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
          </svg>
          <span></span>
        </span>
      </div>

      <p id="modal-description" class="text-gray-700 text-sm leading-relaxed mb-4"></p>

      <div id="modal-location" class="text-gray-500 text-xs mb-4"></div>

      <div id="modal-image" class="rounded-xl overflow-hidden shadow-md hidden">
        <img src="" alt="Issue image" class="w-full object-cover max-h-72">
      </div>
    </div>
  </div>
</div>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fadeIn {
  animation: fadeIn 0.3s ease-out forwards;
}
</style>


</body>
</html>